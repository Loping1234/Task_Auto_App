<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= task.title %> - Task Details</title>
    <link rel="stylesheet" href="/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/taskDetails.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Hide editors and other edit-only UI until Edit is clicked */
        .edit-field { display: none; }
        .editing .edit-field { display: block; }
        .editing .view-field { display: none; }
        /* Keep Quill toolbar hidden in view mode */
        .ql-toolbar { display: none; }
        .editing .ql-toolbar { display: block; }
        /* Quill editor sizing */
        #titleEditor .ql-editor { min-height: 48px; padding: 10px 12px; font-size: 20px; font-weight: 600; }
        #descriptionEditor .ql-editor { min-height: 160px; }
    </style>
</head>
<body>
    <div class="layout">
        <div class="sidebar">
            <h1>Task Details</h1>
            <a href="/admin-dashboard">Back to Dashboard</a>
            <a href="/assign">Assign Task</a>
            <a href="/existingtasks">All Tasks</a>
            <a href="/logout">Logout</a>
        </div>

        <div class="main">
            <div class="task-details-container">
                <form id="inlineEditForm" enctype="multipart/form-data">
                    <div id="successMessage" style="display: none; color: #28a745; margin-bottom: 10px;">
                        Changes saved successfully.
                    </div>
                    <div class="task-details-header">
                        <h2 id="titleView" class="task-title-heading view-field">Title: <%= task.title %></h2>
                        <input type="text" id="titleInput" name="title" value="<%= task.title %>" class="edit-field">
                    </div>
                    <% if (task.titleHistory && task.titleHistory.length) { %>
                        <div class="task-detail-row">
                            <!--<div class="detail-label">Previous Titles:</div>
                            <div class="detail-value">
                                <select id="titleHistorySelect" class="history-select">
                                    <option value="">Revert to...</option>
                                    <% task.titleHistory.slice().reverse().forEach(function(entry) { %>
                                        <option value="<%= entry.value %>">
                                            <%= entry.value || 'Empty title' %> â€” <%= new Date(entry.changedAt).toLocaleString() %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>-->
                        </div>
                    <% } %>

                    <div class="task-details-grid">
                        <div class="details-left">
                            <div class="task-detail-row">
                                <div class="detail-label">Description:</div>
                                <div class="detail-value">
                                    <span id="descriptionView" class="view-field"><span class="Desc-label"></span><%- task.description ? task.description : 'No description provided' %></span>
                                    <div id="descriptionEditor" class="edit-field"></div>
                                    <textarea id="description" name="description" class="edit-field" style="display:none;"></textarea>
                                </div>
                            </div>

                            <div class="task-detail-row">
                                <div class="detail-label">Image:</div>
                                <div class="detail-value">
                                    <% if (task.image) { %>
                                        <img src="/task-img/<%= task._id %>" alt="<%= task.title %>" class="task-image view-field">
                                        <small class="current-image-note view-field">Current image: Yes</small>
                                    <% } else { %>
                                        <span class="view-field">No image uploaded</span>
                                    <% } %>
                                    <input type="file" id="image" name="image" accept="image/*" class="edit-field">
                                </div>
                            </div>
                        </div>

                        <div class="details-right">
                            <div class="task-detail-row">
                                <div class="detail-label">Status:</div>
                                <div class="detail-value">
                                    <select id="statusDropdown" name="status" class="status-dropdown">
                                        <option value="Pending" <%= task.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                                        <option value="inprogress" <%= task.status === 'inprogress' ? 'selected' : '' %>>In Progress</option>
                                        <option value="completed" <%= task.status === 'completed' ? 'selected' : '' %>>Completed</option>
                                    </select>
                                    <span id="savingStatus"></span>
                                </div>
                            </div>

                            <div class="task-detail-row">
                                <div class="detail-label">Assigned To:</div>
                                <div class="detail-value">
                                    <select id="assigneeDropdown" name="assigneeEmail" class="status-dropdown">
                                        <% employees.forEach(function(emp) { %>
                                            <option value="<%= emp.email %>" <%= task.assigneeEmail === emp.email ? 'selected' : '' %>>
                                                <%= emp.email %>
                                            </option>
                                        <% }); %>
                                    </select>
                                    <span id="savingAssignee"></span>
                                </div>
                            </div>

                            <div class="task-detail-row">
                                <div class="detail-label">Start Date:</div>
                                <div class="detail-value">
                                    <span class="view-field"><%= task.startDate ? new Date(task.startDate).toLocaleDateString() : 'N/A' %></span>
                                    <input type="date" id="startDate" name="startDate" value="<%= task.startDate ? new Date(task.startDate).toISOString().split('T')[0] : '' %>" class="edit-field">
                                </div>
                            </div>

                            <div class="task-detail-row">
                                <div class="detail-label">End Date:</div>
                                <div class="detail-value">
                                    <span class="view-field"><%= task.endDate ? new Date(task.endDate).toLocaleDateString() : 'N/A' %></span>
                                    <input type="date" id="endDate" name="endDate" value="<%= task.endDate ? new Date(task.endDate).toISOString().split('T')[0] : '' %>" class="edit-field">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="task-actions">
                        <div class="action-left">
                            <button type="button" class="btn btn-edit" id="editBtn">
                                <i class="fas fa-edit"></i> Edit Task
                            </button>
                            <button type="submit" class="btn btn-save" id="saveBtn" style="display: none;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button type="button" class="btn btn-cancel" id="cancelEditBtn" style="display: none;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="button" class="btn btn-delete" id="deleteBtn">
                                <i class="fas fa-trash"></i> Delete Task
                            </button>
                        </div>
                        <a href="javascript:void(0)" onclick="goBack()" class="btn-back">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </div>
                </form>

                <!-- Activity Log Section -->
                <% if (task.activityLog && task.activityLog.length > 0) { %>
                    <div class="activity-log-section">
                        <h3 class="activity-log-title">
                            <i class="fas fa-history"></i> Activity Log
                        </h3>
                        <div class="activity-log-container">
                            <% task.activityLog.forEach(function(entry) { %>
                                <div class="activity-entry">
                                    <div class="activity-header">
                                        <span class="activity-field"><%= entry.field %></span>
                                        <span class="activity-date"><%= new Date(entry.changedAt).toLocaleString() %></span>
                                    </div>
                                    <div class="activity-change">
                                        <span class="activity-old"><%= entry.oldValue || 'None' %></span>
                                        <i class="fas fa-arrow-right activity-arrow"></i>
                                        <span class="activity-new"><%= entry.newValue || 'None' %></span>
                                    </div>
                                    <div class="activity-user">
                                        <i class="fas fa-user"></i> <%= entry.changedBy %>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const form = document.getElementById('inlineEditForm');
        const editBtn = document.getElementById('editBtn');
        const saveBtn = document.getElementById('saveBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const successMessage = document.getElementById('successMessage');
        const statusDropdown = document.getElementById('statusDropdown');
        const titleView = document.getElementById('titleView');
        const descriptionView = document.getElementById('descriptionView');
        const titleHistorySelect = document.getElementById('titleHistorySelect');
        const descriptionHistorySelect = document.getElementById('descriptionHistorySelect');
        const titleInput = document.getElementById('titleInput');
        const descriptionInput = document.getElementById('description');

        const descriptionQuill = new Quill('#descriptionEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ header: [1, 2, 3, false] }],
                    [{ list: 'ordered' }, { list: 'bullet' }],
                    [{ color: [] }, { background: [] }],
                    ['link'],
                    ['clean']
                ]
            },
            placeholder: 'Edit description'
        });

        const initialDescription = <%- JSON.stringify(task.description || "") %>;
        descriptionQuill.root.innerHTML = initialDescription;
        descriptionInput.value = initialDescription;

        function setEditing(on) {
            if (on) {
                form.classList.add('editing');
                saveBtn.style.display = 'inline-flex';
                cancelEditBtn.style.display = 'inline-flex';
                editBtn.style.display = 'none';
            } else {
                form.classList.remove('editing');
                saveBtn.style.display = 'none';
                cancelEditBtn.style.display = 'none';
                editBtn.style.display = 'inline-flex';
            }
        }

        editBtn.addEventListener('click', () => setEditing(true));

        cancelEditBtn.addEventListener('click', () => {
            form.reset();
            setEditing(false);
            successMessage.style.display = 'none';
            location.reload();
        });

        if (titleHistorySelect) {
            titleHistorySelect.addEventListener('change', () => {
                const value = titleHistorySelect.value;
                if (!value) return;
                titleInput.value = value;
                if (titleView) titleView.textContent = value;
                setEditing(true);
            });
        }

        if (descriptionHistorySelect) {
            descriptionHistorySelect.addEventListener('change', () => {
                const value = descriptionHistorySelect.value;
                if (!value) return;
                descriptionQuill.root.innerHTML = value;
                descriptionInput.value = value;
                if (descriptionView) descriptionView.innerHTML = value;
                setEditing(true);
            });
        }

        // Auto-save status on change (always editable)
        statusDropdown.addEventListener('change', async function() {
            const newStatus = this.value;
            const taskId = '<%= task._id %>';
            const savingSpan = document.getElementById('savingStatus');

            savingSpan.textContent = 'Saving...';
            savingSpan.style.color = '#666';
            savingSpan.style.marginLeft = '10px';

            try {
                const response = await fetch(`/update-status/${taskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    savingSpan.textContent = 'Saved!';
                    savingSpan.style.color = '#28a745';
                    setTimeout(() => {
                        savingSpan.textContent = '';
                    }, 2000);
                } else {
                    savingSpan.textContent = 'Error saving!';
                    savingSpan.style.color = '#dc3545';
                }
            } catch (error) {
                console.error('Error updating status:', error);
                savingSpan.textContent = 'Error!';
                savingSpan.style.color = '#dc3545';
            }
        });

        // Auto-save assignee on change (always editable)
        const assigneeDropdown = document.getElementById('assigneeDropdown');
        if (assigneeDropdown) {
            assigneeDropdown.addEventListener('change', async function() {
                const newAssignee = this.value;
                const taskId = '<%= task._id %>';
                const savingSpan = document.getElementById('savingAssignee');

                savingSpan.textContent = 'Saving...';
                savingSpan.style.color = '#666';
                savingSpan.style.marginLeft = '10px';

                try {
                    const response = await fetch(`/update-assignee/${taskId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ assigneeEmail: newAssignee })
                    });

                    if (response.ok) {
                        savingSpan.textContent = 'Saved!';
                        savingSpan.style.color = '#28a745';
                        setTimeout(() => {
                            savingSpan.textContent = '';
                        }, 2000);
                    } else {
                        savingSpan.textContent = 'Error saving!';
                        savingSpan.style.color = '#dc3545';
                    }
                } catch (error) {
                    console.error('Error updating assignee:', error);
                    savingSpan.textContent = 'Error!';
                    savingSpan.style.color = '#dc3545';
                }
            });
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            descriptionInput.value = descriptionQuill.root.innerHTML;
            const formData = new FormData(form);

            try {
                const response = await fetch('/update-task/<%= task._id %>', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    successMessage.style.display = 'block';
                    setTimeout(() => {
                        location.reload();
                    }, 1200);
                } else {
                    alert('Error updating task. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating task. Please try again.');
            }
        });

        // Delete button handler
        const deleteBtn = document.getElementById('deleteBtn');
        deleteBtn.addEventListener('click', async function() {
            if (!confirm('Delete this task?')) return;
            
            try {
                const deleteForm = document.createElement('form');
                deleteForm.method = 'POST';
                deleteForm.action = '/delete-task/<%= task._id %>';
                document.body.appendChild(deleteForm);
                deleteForm.submit();
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task. Please try again.');
            }
        });

        function goBack() {
            history.back();
        }

        setEditing(false);
    </script>
</body>
</html>